\chapter{Emulation and Hardware in the loop}
\label{cha:emulation}

The fields of emulation and \emph{HiL} are based on real-time simulations combined with a connection to the real world.
Such real world systems can either be a software application (\emph{SiL} - software in the loop) or hardware components (\emph{HiL}).
This connection of simulated systems with real systems can be used for testing and verification of systems under development.
Such a test method can test various different scenarios due to the flexibility of the simulated system.
\cite[section I]{lu_low-cost_2007}

The used simulation can be realized with any simulation technology and existing simulation frameworks, as long as the execution as real-time simulation, as described in section \ref{sec:simulation_real_time}, is possible.
In the section \ref{sec:emulation_omnet} the capabilities regarding emulation and \emph{HiL} provided by the OMNeT++ framework are discussed and analyzed.

The combination of a real-time simulation and a real world system requires a connection in between them.
Such a connection can be established using various functionalities, but must always fulfill the functionality of converting occasions form the real world to simulation events and vice versa.
This connection affects the achievable performance and the temporal behavior of the simulated components respectively to the real world component.
%TODO reference


\section{Emulation and \emph{HiL} using OMNeT++}
\label{sec:emulation_omnet}
For the fields of emulation and \emph{HiL} OMNeT++ provides customizable components within the simulation core and thereby allows different strategies for implementing the required behavior.

\subsection{Existing functionality}
\label{sec:emulation_omnet_existing}

The sample simulation \emph{sockets} shows the possibilities and methods for developing an emulation.
This emulation uses the custom scheduler \emph{SocketRTScheduler}, which is implemented similar to \emph{cRealTimeScheduler} and derived from \emph{cScheduler}.
The custom scheduler holds a TCP socket for communication with the real world.
During wait times the schedule listens to the network interface and converts receiving data to simulation events.
The implementation can be found within the \emph{sockets} sample included in the OMNeT++ framework and \emph{IDE}.
This behavior is usable for this demographic usage, but if the timings of the simulated systems sharpen this scheduler would not allow sufficient communication.
Analyzing the implementation and the achievable timings lead to different possibilities for optimizations as described in \cite{scussel_improvements_2015}.

\section{Communication with the real world}
\label{sec:emulation_communication}
For the fields of emulation and \emph{HiL} the communication with the real world is very important and affects the achievable performance.
By encapsulation of all used communication functionalities in specific modules the simulated model can be clearly separated.
These communication modules can be represented by two separate simple modules which implement the whole connection to the real world separated in receiving and sending.

\begin{description}
    \item[Receiving] The receiving module can be implemented using the \emph{process style} strategy described in section \ref{sec:omnet_components_modules}.
    By using this strategy the module can listen to the communication interface and create simulation events for external occasions.
    Executing the simulation sequentially does not allow constant listening by such a receiver module, therefore this must be interrupted to allow the execution of the remaining simulation.
    For this execution method the scheduler \emph{SocketRTScheduler} used in the \emph{sockets} sample provides a more optimized implementation strategy than the built in \emph{cRealTimeScheduler}.
    
    Using parallel simulation described in chapter \ref{cha:parallel_sim} the receiving module can be implemented blocking.
    Assigning just the receiving module to a single processor allows a constant listening to the communication interface.
    This represents an improved behavior and extended possibility for handling real time occasions.
    
    \item[Sending] The sending module can be implemented independently of the used execution method, except the sending to the communication interface is implemented blocking.
    If the blocking is inevitable this module either should be implemented using the \emph{process style} strategy and be executed on a separate processor or the sending must be executed with care to non blocking behavior.
    Such behavior could be accomplished with timeouts and retries after a defined waiting time while the simulation can proceed.
\end{description}